<div class="container">
      <%= form_with(model: @address, url: offer_address_path, local: true, html: { autocomplete: "off" }) do |f| %>

    <div class="form-group">
      <%= f.label :firstname, Spree.t(:firstname) %>
      <%= f.text_field :firstname, class: 'form-control', autocomplete:"new-password"%>
    </div>
    <div class="form-group">
      <%= f.label :lastname, Spree.t(:lastname) %>
      <%= f.text_field :lastname, class: 'form-control', autocomplete:"new-password" %>
    </div>

    <div class="form-group" id="phone">
      <%= f.label :phone, Spree.t(:phone) %>
      <%= text_field_tag :phone_show, "",class: 'form-control', id: "phone_code" %>
      <%=f.hidden_field :phone, id:"real_phone"%>
    </div>

    <div class="form-group" id="country">
      <%= f.label :country, Spree.t(:country) %>
      <%= f.collection_select :country_id, available_countries, :id, :name,
                                         { prompt: true },
                                         { class: 'required form-control spree-flat-select'} %>

    </div>
    <div class="row">
    <div class=col-6>
      <%= content_tag(:div, Spree.t(:poshta),id: "add_address", class: "btn btn-block btn-lg index_btn text-uppercase font-weight-bold")%>
    </div>
    <div class=col-6>
      <%= content_tag(:div, Spree.t(:nova_poshta),id: "add_poshta", class: "btn btn-block btn-lg index_btn text-uppercase font-weight-bold")%>
    </div>
  <p>&nbsp;</p>
  </div>
    <div class="form-group" id="state">
      <%= f.label :state, Spree.t(:state) %>
      <%= f.collection_select :state_id, {},:id, :name, { required: true },{ class: 'form-control spree-flat-select'}%>

    </div>

    <div class="form-group" id="city">
      <%= f.label :city, Spree.t(:city) %>
      <%= f.text_field :city, class: 'form-control', autocomplete:"new-password" %>
    </div>
    <div class="form-group" id="address1">
      <%= f.label :address1, Spree.t(:address1) %>
      <%= f.text_field :address1, class: 'form-control', autocomplete:"new-password" %>
    </div>

    <div class="form-group" id="nova_poshta">
      <%= f.label :nova_poshta_address, Spree.t(:nova_poshta_address) %>
      <%=f.text_field :nova_poshta_address, {list:"address_nova_poshta_area", id:"address_nova_poshta_area1", class: 'form-control', autocomplete:"new-password" }%>

      <datalist id="address_nova_poshta_area" autocomplete="off">

      </datalist>
      <input type="hidden" id="nova_poshta_address" value="">
    </div>


    <div class="form-group" id="nova_poshta_number">
      <%= f.label :nova_poshta_number, Spree.t(:nova_poshta_number) %>
      <%= f.collection_select :nova_poshta_number, {},:id, :name, {prompt: true}, {class: 'form-control spree-flat-select'} %>
    </div>

    <div class="form-group">
      <%= hidden_field_tag "id", @offer.id %>
      <%=f.hidden_field "user_id", value: @offer.user.id%>
      <%=f.submit Spree.t(:add_address), class: 'btn btn-block btn-lg index_btn text-uppercase font-weight-bold', id: "form_address_offer"%>
  </div>
    <%end%>
</div>
<script>
document.addEventListener('turbolinks:load', function () {

  $("#phone_code").intlTelInput({
      formatOnInit: true,
      separateDialCode: true,
      onlyCountries: ["ua","pl","ru"]
  });

  $( "#phone_code" ).keyup(function(e) {
    e.preventDefault();
    if ($(this).val().length > 8) {

   var input_value = $( this ).val().replace(/\s/g, '').replace(/[()]/g, '');
    var intlNumber = $("#phone_code").intlTelInput("getSelectedCountryData");
    var final_phone = `+${intlNumber.dialCode+input_value}`
    $("#real_phone").val(final_phone).trigger('change');
  }
  });

  $( "#phone_code" ).on('countrychange', function(e, countryData){
    var intlNumber = countryData.dialCode;
    var input_value = $( this ).val().replace(/\s/g, '').replace(/[()]/g, '');
    var final_phone = `+${intlNumber+input_value}`
    $("#real_phone").val(final_phone).trigger('change');
})


$("#state").hide();
$("#city").hide();
$("#address1").hide();
$("#nova_poshta").hide();
$("#nova_poshta_number").hide();
$("#add_address").hide();
$("#add_poshta").hide();
$("#country").change(function(event) {

var countryId  =  $('#country').find(":selected").val();

if (countryId == 230){
  $("#nova_poshta").hide();
  $("#nova_poshta_number").hide();
  $("#state").hide();
  $("#city").hide();
  $("#address1").hide();
  $("#add_address").show();
  $("#add_poshta").show();
$("#add_address").click(function(event) {
  $("#address_nova_poshta_number").val("")
  $("#address_nova_poshta_area1").val("");

$.ajax({
              async: false,
              method: 'GET',
              url: Spree.pathFor('/api/v2/storefront/countries/' + countryId + '?include=states'),
              dataType: 'json'
            }).done(function(data) {
              $('#address_state_id').empty();
              if ("<%=I18n.locale %>" == "uk"){
              $('#address_state_id').append(new Option("Оберіть регіон"));
            }else{
              $('#address_state_id').append(new Option("Выберите регион"));
            }
            var json = data.included;
            for (var i = 0; i < json.length; i++) {
              var obj = json[i];
              $('#address_state_id').append(new Option(obj.attributes.name, obj.id));

            }


});


$("#nova_poshta").hide();
$("#nova_poshta_number").hide();
$("#state").show();
$("#city").show();
$("#address1").show();
});

$( "#add_poshta" ).click(function() {
  $("#address_state").val("");
  $("#address_city").val("");
  $("#address_address1").val("");
  $('#address_state_id').val("");
  $("#state").hide();
  $("#city").hide();
  $("#address1").hide();

  $("#nova_poshta").show();
  if ("<%=I18n.locale %>" == "ru"){
  localStorage.clear();

  var settings = {
    modelName: "Address",
    calledMethod: "getCities",
    methodProperties: {},
    apiKey: "<%=Rails.application.credentials[:nova_poshta]%>"
  };

  $.ajax({
          url: "https://api.novaposhta.ua/v2.0/json/",
          method: "POST",
          processData: false,
          crossDomain: true,
          async: true,
          contentType: "application/json",
          data: JSON.stringify(settings)
      }).done(function (response) {

        var json = response.data;
        for (var i = 0; i < json.length; i++) {
          var obj = json[i];
          var ru ={
            "desc": `${obj.SettlementTypeDescriptionRu + ' ' +obj.DescriptionRu.trim().replace(/ *\([^)]*\) */g, "")+ ', '+'обл.'+obj.AreaDescriptionRu}`,
            "ref": `${obj.Ref}`
          }
          localStorage.setItem( `${(obj.DescriptionRu).trim().replace(/ *\([^)]*\) */g, "")}`, JSON.stringify(ru))

        }

      });
}

  $('#address_nova_poshta_area1').keyup(function(e) {
    e.preventDefault();
    if ($(this).val().length > 2) {

   var input_value = $( this ).val();
   var final_input_value = input_value.charAt(0).toUpperCase() + input_value.slice(1).toLowerCase();

   if ("<%=I18n.locale %>" == "uk"){
     var settings = {
       modelName: "Address",
       calledMethod: "getCities",
       methodProperties: {
         FindByString: final_input_value
       },
       apiKey: "<%=Rails.application.credentials[:nova_poshta]%>"

     };


   $.ajax({
         url: "https://api.novaposhta.ua/v2.0/json/",
         method: "POST",
         processData: false,
         crossDomain: true,
         async: true,
         contentType: "application/json",
         data: JSON.stringify(settings)
     }).done(function (response) {
       $('#address_nova_poshta_area').empty();
       var json = response.data;
       for (var i = 0; i < json.length; i++) {
         var obj = json[i];
         $('#address_nova_poshta_area').append(
           `<option data-value=${obj.Ref}>
           ${obj.SettlementTypeDescription + ' ' +(obj.Description).trim().replace(/ *\([^)]*\) */g, "") + ', '+"обл."+obj.AreaDescription}
           </option>`
         );
       }
     });

 }else{

    var json = JSON.parse(localStorage.getItem(final_input_value))


    $('#address_nova_poshta_area').empty();

      $('#address_nova_poshta_area').append(
        `<option data-value=${json['ref']}>
        ${json["desc"]}
        </option>`
      );
    }

  }
e.preventDefault();
});
$('#address_nova_poshta_area1').change(function (e) {
  e.preventDefault();
    var val =  $(this).val();
    var hidden_value = $('#address_nova_poshta_area option').filter(function() {
     return this.value == val;
   }).data('value');
   $("#nova_poshta_address").val(hidden_value).trigger('change');
});
$('#nova_poshta_address').change(function (e) {
  e.preventDefault();
  var cityRef =  $(this).val();
if (cityRef.length > 4){
  var settings = {
    modelName: "AddressGeneral",
    calledMethod: "getWarehouses",
    methodProperties: {
      CityRef: cityRef
    },
    apiKey: "<%=Rails.application.credentials[:nova_poshta]%>"
  };

  $.ajax({
        url: "https://api.novaposhta.ua/v2.0/json/",
        method: "POST",
        processData: false,
        crossDomain: true,
        async: true,
        contentType: "application/json",
        data: JSON.stringify(settings)
    }).done(function (response) {
      $('#address_nova_poshta_number').empty();
      var json = response.data;
      for (var i = 0; i < json.length; i++) {
        var obj = json[i];
        if ("<%=I18n.locale %>" == "uk"){
        $('#address_nova_poshta_number').append(new Option(obj.Description, obj.Description));
      }else{
        $('#address_nova_poshta_number').append(new Option(obj.DescriptionRu, obj.DescriptionRu));
      }
      }
    });
    $('#nova_poshta_number').show();
    e.preventDefault();
  }
});
});
}else{
  $("#add_address").hide();
  $("#add_poshta").hide();
  $("#nova_poshta").hide();
  $('#nova_poshta_number').hide();
  $('#address_nova_poshta_number').empty();
  $('#address_nova_poshta_number').val("");
  $('#address_nova_poshta_area1').empty();
  $('#address_nova_poshta_area1').val("");
  $("#address_state").val("");
  $("#address_city").val("");
  $("#address_address1").val("");
  $('#address_state_id').val("");
  $("#state").hide();
  $("#city").hide();
  $("#address1").hide();

  $.ajax({
                async: false,
                method: 'GET',
                url: Spree.pathFor('/api/v2/storefront/countries/' + countryId + '?include=states'),
                dataType: 'json'
              }).done(function(data) {
                $('#address_state_id').empty();
                if ("<%=I18n.locale %>" == "uk"){
                $('#address_state_id').append(new Option("Оберіть регіон"));
              }else{
                $('#address_state_id').append(new Option("Выберите регион"));
              }
              var json = data.included;
              for (var i = 0; i < json.length; i++) {
                var obj = json[i];
                $('#address_state_id').append(new Option(obj.attributes.name, obj.id));

              }


  });
  $("#state").show();
  $("#city").show();
  $("#address1").show();

}
});

$( "#form_address_offer" ).click(function( event ) {
  if ("<%=I18n.locale %>" == "ru"){
  localStorage.clear();
}
});

});
</script>
